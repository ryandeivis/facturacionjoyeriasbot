# Mapa Conceptual: Ciclo de Vida de los Datos - Jewelry Invoice Bot

## ğŸ“‹ Resumen Ejecutivo

Este documento presenta el flujo completo de datos del proyecto, dividido en:
1. **Frontend**: Flujo visible para el usuario (captura â†’ verificaciÃ³n â†’ PDF)
2. **Backend**: Flujo interno (funciones, base de datos, mÃ©tricas)

---

## ğŸ¨ FRONTEND: Flujo del Usuario

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ASESOR (Telegram)                                  â”‚
â”‚  Proporciona: Texto, Audio o Foto con datos de factura                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         n8n: EXTRACCIÃ“N (IA)                                â”‚
â”‚  â€¢ Whisper (audio â†’ texto)                                                  â”‚
â”‚  â€¢ Vision AI (foto â†’ texto)                                                 â”‚
â”‚  â€¢ GPT-4 (texto â†’ items estructurados)                                      â”‚
â”‚  Extrae: Items, Cliente, Totales, Confianza                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BOT: VERIFICACIÃ“N                                       â”‚
â”‚  Muestra al usuario:                                                         â”‚
â”‚  â€¢ ğŸ“¦ Productos detectados (nombre, cantidad, precio)                       â”‚
â”‚  â€¢ ğŸ‘¤ Cliente detectado (nombre, telÃ©fono, direcciÃ³n)                       â”‚
â”‚  â€¢ ğŸ¤ TranscripciÃ³n del audio (si aplica)                                   â”‚
â”‚  Opciones: âœ… Continuar | âœï¸ Editar | âŒ Cancelar                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      n8n: GENERACIÃ“N PDF                                     â”‚
â”‚  â€¢ Recibe datos de factura                                                  â”‚
â”‚  â€¢ Crea Google Doc con HTML                                                 â”‚
â”‚  â€¢ Exporta como PDF                                                          â”‚
â”‚  Retorna: URL del PDF, base64, filename                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      USUARIO RECIBE                                          â”‚
â”‚  â€¢ ğŸ“„ Archivo HTML (visualizar en navegador)                                â”‚
â”‚  â€¢ ğŸ“‘ Archivo PDF (descargar/imprimir)                                      â”‚
â”‚  â€¢ âœ… ConfirmaciÃ³n con nÃºmero de factura                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ BACKEND: Arquitectura de Datos Detallada

### 1. CAPTURA DE INPUT DEL ASESOR

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ARCHIVO: src/bot/handlers/invoice.py                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  iniciar_nueva_factura() [lÃ­nea 97]                                         â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â””â”€â–º context.user_data['estado'] = 'SELECCIONAR_INPUT'                  â”‚
â”‚                                                                              â”‚
â”‚  seleccionar_tipo_input() [lÃ­nea 125]                                        â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â”œâ”€â–º InputType.TEXTO â†’ espera mensaje de texto                          â”‚
â”‚      â”œâ”€â–º InputType.VOZ â†’ espera archivo .ogg                                â”‚
â”‚      â””â”€â–º InputType.FOTO â†’ espera imagen .jpg                                â”‚
â”‚                                                                              â”‚
â”‚  recibir_input() [lÃ­nea 181]                                                 â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â”œâ”€â–º TEXTO: text = update.message.text                                  â”‚
â”‚      â”‚         TextParserService.parse(text) [LOCAL]                        â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â”œâ”€â–º VOZ:   audio = update.message.voice                                â”‚
â”‚      â”‚         file = await audio.get_file()                                â”‚
â”‚      â”‚         await file.download_to_drive(audio_path)                     â”‚
â”‚      â”‚         n8n_service.send_voice_input(audio_path, cedula)             â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â””â”€â–º FOTO:  photo = update.message.photo[-1]                            â”‚
â”‚                file = await photo.get_file()                                â”‚
â”‚                await file.download_to_drive(photo_path)                     â”‚
â”‚                n8n_service.send_photo_input(photo_path, cedula)             â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ARCHIVO: src/services/n8n_service.py                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  class N8NService:                                                           â”‚
â”‚                                                                              â”‚
â”‚  send_text_input(text, vendedor_cedula, org_id) [lÃ­nea 79]                  â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â””â”€â–º _build_extract_payload() â†’ {                                       â”‚
â”‚              "type": "text",                                                â”‚
â”‚              "content": text,                                               â”‚
â”‚              "vendedor_cedula": "123456",                                   â”‚
â”‚              "organization_id": "org-uuid",                                 â”‚
â”‚              "timestamp": "2025-12-31T10:30:00"                             â”‚
â”‚          }                                                                   â”‚
â”‚                                                                              â”‚
â”‚  send_voice_input(audio_path, vendedor_cedula, org_id) [lÃ­nea 104]          â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â”œâ”€â–º Lee archivo: with open(audio_path, 'rb') as f                      â”‚
â”‚      â”œâ”€â–º Codifica: base64.b64encode(f.read())                               â”‚
â”‚      â””â”€â–º _build_extract_payload() â†’ {                                       â”‚
â”‚              "type": "voice",                                               â”‚
â”‚              "content": "<base64-audio>",                                   â”‚
â”‚              "content_type": "audio/ogg",                                   â”‚
â”‚              ...                                                            â”‚
â”‚          }                                                                   â”‚
â”‚                                                                              â”‚
â”‚  send_photo_input(photo_path, vendedor_cedula, org_id) [lÃ­nea 141]          â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â”œâ”€â–º Lee imagen: with open(photo_path, 'rb') as f                       â”‚
â”‚      â”œâ”€â–º Codifica: base64.b64encode(f.read())                               â”‚
â”‚      â””â”€â–º _build_extract_payload() â†’ {                                       â”‚
â”‚              "type": "photo",                                               â”‚
â”‚              "content": "<base64-image>",                                   â”‚
â”‚              "content_type": "image/jpeg",                                  â”‚
â”‚              ...                                                            â”‚
â”‚          }                                                                   â”‚
â”‚                                                                              â”‚
â”‚  _send_extract_request(payload) [lÃ­nea 293]                                 â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â””â”€â–º POST settings.N8N_WEBHOOK_URL/webhook/jewelry-extract              â”‚
â”‚          â””â”€â–º Headers: Content-Type: application/json                        â”‚
â”‚          â””â”€â–º Timeout: settings.N8N_TIMEOUT_SECONDS (60s)                    â”‚
â”‚                                                                              â”‚
â”‚  _parse_extract_response(data) [lÃ­nea 373]                                  â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â””â”€â–º Retorna N8NResponse:                                               â”‚
â”‚          {                                                                   â”‚
â”‚            "success": true,                                                  â”‚
â”‚            "items": [                                                        â”‚
â”‚              {"numero": 1, "nombre": "Anillo Oro 18K",                      â”‚
â”‚               "cantidad": 1, "precio": 2500000}                             â”‚
â”‚            ],                                                                â”‚
â”‚            "cliente": {"nombre": "Juan", "telefono": "300..."},             â”‚
â”‚            "totales": {"subtotal": 2500000, "impuesto": 475000},            â”‚
â”‚            "transcripcion": "...",                                          â”‚
â”‚            "confianza": 0.95                                                 â”‚
â”‚          }                                                                   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2. ALMACENAMIENTO EN CONTEXTO DEL BOT

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DATOS EN context.user_data (memoria de sesiÃ³n Telegram)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  DespuÃ©s de recibir_input() [lÃ­nea 350-380]:                                 â”‚
â”‚                                                                              â”‚
â”‚  context.user_data = {                                                       â”‚
â”‚      'cedula': '123456789',           # CÃ©dula del vendedor (autenticado)   â”‚
â”‚      'organization_id': 'org-uuid',   # Tenant del vendedor                 â”‚
â”‚      'estado': 'CONFIRMAR_DATOS',     # Estado actual del flujo             â”‚
â”‚      'input_type': 'VOZ',             # Tipo de input usado                 â”‚
â”‚      'input_raw': '/path/to/audio.ogg', # Archivo original                  â”‚
â”‚      'n8n_response': {                                                       â”‚
â”‚          'items': [                                                          â”‚
â”‚              {                                                               â”‚
â”‚                  'numero': 1,                                               â”‚
â”‚                  'nombre': 'Anillo Oro 18K',        # Title Case            â”‚
â”‚                  'descripcion': 'Solitario diamante',                       â”‚
â”‚                  'cantidad': 1,                                             â”‚
â”‚                  'precio': 2500000,                                         â”‚
â”‚                  'total': 2500000                                           â”‚
â”‚              }                                                               â”‚
â”‚          ],                                                                  â”‚
â”‚          'cliente': {                                                        â”‚
â”‚              'nombre': 'Juan PÃ©rez',                # Title Case            â”‚
â”‚              'telefono': '3001234567',                                      â”‚
â”‚              'direccion': 'Calle 123',                                      â”‚
â”‚              'ciudad': 'BogotÃ¡',                                            â”‚
â”‚              'email': 'juan@email.com'                                      â”‚
â”‚          },                                                                  â”‚
â”‚          'totales': {                                                        â”‚
â”‚              'subtotal': 2500000,                                           â”‚
â”‚              'descuento': 0,                                                â”‚
â”‚              'impuesto': 475000,                                            â”‚
â”‚              'total': 2975000                                               â”‚
â”‚          },                                                                  â”‚
â”‚          'transcripcion': 'Un anillo de oro 18 kilates...',                 â”‚
â”‚          'confianza': 0.95                                                  â”‚
â”‚      }                                                                       â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3. FLUJO DE DATOS DEL CLIENTE

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ARCHIVO: src/bot/handlers/invoice.py                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  confirmar_datos() [lÃ­nea 477]                                               â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â”œâ”€â–º Si "Continuar": pasa a datos_cliente()                             â”‚
â”‚      â””â”€â–º Si "Editar": pasa a editar_items()                                 â”‚
â”‚                                                                              â”‚
â”‚  datos_cliente() [lÃ­nea 590]                                                 â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â”œâ”€â–º Muestra: "ğŸ“ Ingrese el NOMBRE del cliente:"                       â”‚
â”‚      â””â”€â–º Valida: IdentityValidator.validate_nombre_persona(nombre)          â”‚
â”‚                                                                              â”‚
â”‚  cliente_direccion() [lÃ­nea 614]                                             â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â”œâ”€â–º Guarda: context.user_data['cliente_nombre'] = nombre               â”‚
â”‚      â”œâ”€â–º Muestra: "ğŸ“ Ingrese la DIRECCIÃ“N (o 'omitir'):"                   â”‚
â”‚      â””â”€â–º Si "omitir": direccion = None                                      â”‚
â”‚                                                                              â”‚
â”‚  cliente_ciudad() [lÃ­nea 628]                                                â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â”œâ”€â–º Guarda: context.user_data['cliente_direccion'] = direccion         â”‚
â”‚      â”œâ”€â–º Muestra: "ğŸ™ï¸ Ingrese la CIUDAD (o 'omitir'):"                      â”‚
â”‚      â””â”€â–º Si "omitir": ciudad = None                                         â”‚
â”‚                                                                              â”‚
â”‚  cliente_email() [lÃ­nea 642]                                                 â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â”œâ”€â–º Guarda: context.user_data['cliente_ciudad'] = ciudad               â”‚
â”‚      â”œâ”€â–º Muestra: "ğŸ“§ Ingrese el EMAIL (o 'omitir'):"                       â”‚
â”‚      â””â”€â–º Valida: Formato email vÃ¡lido                                       â”‚
â”‚                                                                              â”‚
â”‚  _mostrar_resumen_factura() [lÃ­nea 654]                                      â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â””â”€â–º Construye resumen completo para confirmar:                         â”‚
â”‚          â€¢ Cliente (nombre, direcciÃ³n, ciudad, email)                       â”‚
â”‚          â€¢ Productos (cantidad Ã— precio = subtotal)                         â”‚
â”‚          â€¢ Impuesto (19%)                                                    â”‚
â”‚          â€¢ Total final                                                       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4. PERSISTENCIA EN BASE DE DATOS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ARCHIVO: src/bot/handlers/invoice.py                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  generar_factura() [lÃ­nea 695]                                               â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â”œâ”€â–º Rate limit check (evita spam)                                       â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â”œâ”€â–º Construye invoice_data:                                             â”‚
â”‚      â”‚   {                                                                   â”‚
â”‚      â”‚     "organization_id": "org-uuid",                                   â”‚
â”‚      â”‚     "vendedor_id": user.id,                                          â”‚
â”‚      â”‚     "cliente_nombre": "Juan PÃ©rez",                                  â”‚
â”‚      â”‚     "cliente_direccion": "Calle 123",                                â”‚
â”‚      â”‚     "cliente_ciudad": "BogotÃ¡",                                      â”‚
â”‚      â”‚     "cliente_email": "juan@email.com",                               â”‚
â”‚      â”‚     "items": [...],                                                  â”‚
â”‚      â”‚     "subtotal": 2500000,                                             â”‚
â”‚      â”‚     "impuesto": 475000,                                              â”‚
â”‚      â”‚     "total": 2975000,                                                â”‚
â”‚      â”‚     "estado": "PENDIENTE",                                           â”‚
â”‚      â”‚     "input_type": "VOZ",                                             â”‚
â”‚      â”‚     "n8n_processed": True                                            â”‚
â”‚      â”‚   }                                                                   â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â””â”€â–º create_invoice(db, invoice_data) [lÃ­nea 759]                       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ARCHIVO: src/database/queries/invoice_queries.py                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  create_invoice_with_items_async(db, invoice_data, items, customer_data)    â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â”‚  TRANSACCIÃ“N ATÃ“MICA:                                                â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â”œâ”€â–º 1. BUSCAR/CREAR CLIENTE                                            â”‚
â”‚      â”‚   find_or_create_customer_async(db, org_id, customer_data)           â”‚
â”‚      â”‚       â”‚                                                               â”‚
â”‚      â”‚       â”œâ”€â–º Busca por cedula: SELECT * FROM customers                  â”‚
â”‚      â”‚       â”‚     WHERE cedula = '123' AND organization_id = 'org'         â”‚
â”‚      â”‚       â”‚     AND is_deleted = False                                   â”‚
â”‚      â”‚       â”‚                                                               â”‚
â”‚      â”‚       â”œâ”€â–º Si no existe, busca por telÃ©fono:                          â”‚
â”‚      â”‚       â”‚     SELECT * FROM customers                                  â”‚
â”‚      â”‚       â”‚     WHERE telefono = '300...' AND organization_id = 'org'    â”‚
â”‚      â”‚       â”‚                                                               â”‚
â”‚      â”‚       â””â”€â–º Si no existe, crea nuevo:                                  â”‚
â”‚      â”‚             INSERT INTO customers                                    â”‚
â”‚      â”‚             (id, organization_id, nombre, cedula, telefono,          â”‚
â”‚      â”‚              email, direccion, ciudad, created_at)                   â”‚
â”‚      â”‚             VALUES (uuid, 'org', 'Juan', '123', '300...',           â”‚
â”‚      â”‚                     'juan@', 'Calle', 'BogotÃ¡', now())              â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â”œâ”€â–º 2. GENERAR NÃšMERO DE FACTURA                                       â”‚
â”‚      â”‚   generate_invoice_number(db, org_id)                                â”‚
â”‚      â”‚       â”‚                                                               â”‚
â”‚      â”‚       â”œâ”€â–º SELECT prefix FROM tenant_configs                          â”‚
â”‚      â”‚       â”‚     WHERE organization_id = 'org'                            â”‚
â”‚      â”‚       â”‚     â†’ prefix = 'FAC'                                         â”‚
â”‚      â”‚       â”‚                                                               â”‚
â”‚      â”‚       â”œâ”€â–º SELECT MAX(numero_factura) FROM invoices                   â”‚
â”‚      â”‚       â”‚     WHERE organization_id = 'org'                            â”‚
â”‚      â”‚       â”‚     â†’ Ãºltimo = 'FAC-202512-0042'                             â”‚
â”‚      â”‚       â”‚                                                               â”‚
â”‚      â”‚       â””â”€â–º Retorna: 'FAC-202512-0043'                                 â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â”œâ”€â–º 3. CREAR FACTURA                                                   â”‚
â”‚      â”‚   INSERT INTO invoices                                               â”‚
â”‚      â”‚   (id, organization_id, numero_factura, customer_id,                 â”‚
â”‚      â”‚    cliente_nombre, cliente_direccion, cliente_ciudad,                â”‚
â”‚      â”‚    cliente_email, items, subtotal, descuento, impuesto,              â”‚
â”‚      â”‚    total, estado, vendedor_id, input_type, input_raw,                â”‚
â”‚      â”‚    n8n_processed, created_at, updated_at)                            â”‚
â”‚      â”‚   VALUES (...)                                                        â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â”œâ”€â–º 4. CREAR ITEMS NORMALIZADOS                                        â”‚
â”‚      â”‚   create_invoice_items_async(db, invoice.id, items)                  â”‚
â”‚      â”‚       â”‚                                                               â”‚
â”‚      â”‚       â””â”€â–º Para cada item:                                            â”‚
â”‚      â”‚           INSERT INTO invoice_items                                  â”‚
â”‚      â”‚           (id, invoice_id, numero, descripcion, cantidad,            â”‚
â”‚      â”‚            precio_unitario, subtotal, material, peso_gramos,         â”‚
â”‚      â”‚            tipo_prenda, created_at)                                  â”‚
â”‚      â”‚           VALUES (...)                                               â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â””â”€â–º 5. COMMIT TRANSACCIÃ“N                                              â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 5. ESQUEMA DE BASE DE DATOS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ESQUEMA DE TABLAS                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚    organizations    â”‚     â”‚       users         â”‚     â”‚      customers      â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ id (PK)             â”‚â—„â”€â”€â”€â”€â”‚ organization_id(FK) â”‚     â”‚ id (PK)             â”‚   â”‚
â”‚  â”‚ name                â”‚     â”‚ id (PK)             â”‚     â”‚ organization_id(FK) â”‚â”€â”€â”€â–ºâ”‚
â”‚  â”‚ slug                â”‚     â”‚ cedula              â”‚     â”‚ nombre              â”‚   â”‚
â”‚  â”‚ plan                â”‚     â”‚ nombre_completo     â”‚     â”‚ cedula              â”‚   â”‚
â”‚  â”‚ status              â”‚     â”‚ email               â”‚     â”‚ telefono            â”‚   â”‚
â”‚  â”‚ settings (JSON)     â”‚     â”‚ telefono            â”‚     â”‚ email               â”‚   â”‚
â”‚  â”‚ created_at          â”‚     â”‚ telegram_id         â”‚     â”‚ direccion           â”‚   â”‚
â”‚  â”‚ is_deleted          â”‚     â”‚ rol                 â”‚     â”‚ ciudad              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ activo              â”‚     â”‚ notas               â”‚   â”‚
â”‚           â”‚                  â”‚ ultimo_login        â”‚     â”‚ created_at          â”‚   â”‚
â”‚           â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ is_deleted          â”‚   â”‚
â”‚           â”‚                           â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                           â”‚                           â”‚               â”‚
â”‚           â–¼                           â–¼                           â–¼               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                invoices                                      â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ id (PK)                   â”‚ Identificador Ãºnico UUID                         â”‚   â”‚
â”‚  â”‚ organization_id (FK)      â”‚ Tenant que posee la factura                     â”‚   â”‚
â”‚  â”‚ numero_factura (UNIQUE)   â”‚ FAC-YYYYMM-NNNN formato                         â”‚   â”‚
â”‚  â”‚ customer_id (FK)          â”‚ Cliente normalizado (nuevo)                     â”‚   â”‚
â”‚  â”‚ cliente_nombre            â”‚ Nombre cliente (legacy/redundante)              â”‚   â”‚
â”‚  â”‚ cliente_direccion         â”‚ DirecciÃ³n cliente                               â”‚   â”‚
â”‚  â”‚ cliente_ciudad            â”‚ Ciudad cliente                                  â”‚   â”‚
â”‚  â”‚ cliente_email             â”‚ Email cliente                                   â”‚   â”‚
â”‚  â”‚ cliente_telefono          â”‚ TelÃ©fono cliente                                â”‚   â”‚
â”‚  â”‚ cliente_cedula            â”‚ CÃ©dula cliente                                  â”‚   â”‚
â”‚  â”‚ items (JSON)              â”‚ Items en JSON (legacy/redundante)               â”‚   â”‚
â”‚  â”‚ subtotal                  â”‚ Suma de items                                   â”‚   â”‚
â”‚  â”‚ descuento                 â”‚ Descuento aplicado                              â”‚   â”‚
â”‚  â”‚ impuesto                  â”‚ IVA 19%                                         â”‚   â”‚
â”‚  â”‚ total                     â”‚ Total a pagar                                   â”‚   â”‚
â”‚  â”‚ estado                    â”‚ BORRADOR|PENDIENTE|PAGADA|ANULADA              â”‚   â”‚
â”‚  â”‚ vendedor_id (FK)          â”‚ Usuario que creÃ³ la factura                    â”‚   â”‚
â”‚  â”‚ fecha_pago                â”‚ Cuando se pagÃ³ (nullable)                      â”‚   â”‚
â”‚  â”‚ input_type                â”‚ TEXTO|VOZ|FOTO                                  â”‚   â”‚
â”‚  â”‚ input_raw                 â”‚ Input original (path o texto)                   â”‚   â”‚
â”‚  â”‚ n8n_processed             â”‚ Si fue procesado por IA                         â”‚   â”‚
â”‚  â”‚ n8n_response (JSON)       â”‚ Respuesta completa de n8n                       â”‚   â”‚
â”‚  â”‚ notas                     â”‚ Notas adicionales                               â”‚   â”‚
â”‚  â”‚ created_at                â”‚ Fecha creaciÃ³n                                  â”‚   â”‚
â”‚  â”‚ updated_at                â”‚ Fecha Ãºltima modificaciÃ³n                       â”‚   â”‚
â”‚  â”‚ is_deleted                â”‚ Soft delete flag                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                                                        â”‚
â”‚           â”‚ 1:N                                                                    â”‚
â”‚           â–¼                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                            invoice_items                                     â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ id (PK)                   â”‚ Identificador autoincrement                     â”‚   â”‚
â”‚  â”‚ invoice_id (FK)           â”‚ Factura a la que pertenece                      â”‚   â”‚
â”‚  â”‚ numero                    â”‚ Orden del item (1, 2, 3...)                     â”‚   â”‚
â”‚  â”‚ descripcion               â”‚ "Anillo Oro 18K Solitario"                      â”‚   â”‚
â”‚  â”‚ cantidad                  â”‚ Cantidad (â‰¥1)                                   â”‚   â”‚
â”‚  â”‚ precio_unitario           â”‚ Precio por unidad                               â”‚   â”‚
â”‚  â”‚ subtotal                  â”‚ cantidad Ã— precio_unitario                      â”‚   â”‚
â”‚  â”‚ material                  â”‚ oro_18k|plata_925|oro_rosa|etc                 â”‚   â”‚
â”‚  â”‚ peso_gramos               â”‚ Peso en gramos (joyerÃ­a)                        â”‚   â”‚
â”‚  â”‚ tipo_prenda               â”‚ anillo|cadena|arete|pulsera|etc                â”‚   â”‚
â”‚  â”‚ created_at                â”‚ Fecha creaciÃ³n                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 6. SISTEMA DE MÃ‰TRICAS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CAPTURA DE MÃ‰TRICAS DE USO DEL BOT                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ARCHIVO: src/metrics/tracker.py (MetricsTracker)                            â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     EVENTOS QUE SE CAPTURAN                            â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  FACTURAS:                                                             â”‚  â”‚
â”‚  â”‚  â”œâ”€â–º track_invoice_created(org_id, amount, user_id)                   â”‚  â”‚
â”‚  â”‚  â”‚     â””â”€â–º EVENT: invoice.created                                     â”‚  â”‚
â”‚  â”‚  â”‚         metadata: {"amount": 2975000}                              â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€â–º track_invoice_paid(org_id, amount, invoice_id, time_to_payment)  â”‚  â”‚
â”‚  â”‚  â”‚     â””â”€â–º EVENT: invoice.paid                                        â”‚  â”‚
â”‚  â”‚  â”‚         metadata: {"invoice_id": "...", "days_to_pay": 5}          â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚  â””â”€â–º track_invoice_status_changed(org_id, invoice_id, old, new)       â”‚  â”‚
â”‚  â”‚        â””â”€â–º EVENT: invoice.status_changed                              â”‚  â”‚
â”‚  â”‚            metadata: {"old_status": "PENDIENTE", "new_status": "PAGADA"}â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  BOT:                                                                  â”‚  â”‚
â”‚  â”‚  â”œâ”€â–º track_bot_command(org_id, user_id, command, duration_ms)         â”‚  â”‚
â”‚  â”‚  â”‚     â””â”€â–º EVENT: bot.command                                         â”‚  â”‚
â”‚  â”‚  â”‚         metadata: {"command": "/start"}                            â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€â–º track_bot_photo(org_id, user_id, success, duration_ms)           â”‚  â”‚
â”‚  â”‚  â”‚     â””â”€â–º EVENT: bot.photo                                           â”‚  â”‚
â”‚  â”‚  â”‚         success: true/false, duration_ms: 2450                     â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€â–º track_bot_voice(org_id, user_id, success, duration_ms)           â”‚  â”‚
â”‚  â”‚  â”‚     â””â”€â–º EVENT: bot.voice                                           â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚  â””â”€â–º track_bot_error(org_id, user_id, error_type, error_message)      â”‚  â”‚
â”‚  â”‚        â””â”€â–º EVENT: bot.error                                           â”‚  â”‚
â”‚  â”‚            metadata: {"error_type": "validation", "message": "..."}   â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  IA/EXTRACCIÃ“N:                                                        â”‚  â”‚
â”‚  â”‚  â””â”€â–º track_ai_extraction(org_id, user_id, type, success,              â”‚  â”‚
â”‚  â”‚  â”‚                        duration_ms, items_count, confidence)       â”‚  â”‚
â”‚  â”‚  â”‚     â”œâ”€â–º EVENT: ai.extraction                                       â”‚  â”‚
â”‚  â”‚  â”‚     â”œâ”€â–º EVENT: ai.extraction.success (si success=true)             â”‚  â”‚
â”‚  â”‚  â”‚     â””â”€â–º EVENT: ai.extraction.failed (si success=false)             â”‚  â”‚
â”‚  â”‚  â”‚         metadata: {"extraction_type": "photo",                     â”‚  â”‚
â”‚  â”‚  â”‚                    "items_extracted": 3, "confidence": 0.95}       â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  CLIENTES:                                                             â”‚  â”‚
â”‚  â”‚  â”œâ”€â–º track_customer_new(org_id, cedula, nombre, user_id)              â”‚  â”‚
â”‚  â”‚  â”‚     â””â”€â–º EVENT: customer.new                                        â”‚  â”‚
â”‚  â”‚  â”‚         metadata: {"cedula": "123...", "nombre": "Juan"}           â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚  â””â”€â–º track_customer_returning(org_id, customer_id, user_id)           â”‚  â”‚
â”‚  â”‚        â””â”€â–º EVENT: customer.returning                                  â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  PRODUCTOS/VENTAS:                                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€â–º track_product_sale(org_id, user_id, descripcion, cantidad,       â”‚  â”‚
â”‚  â”‚  â”‚                       precio, material, tipo_prenda, peso)         â”‚  â”‚
â”‚  â”‚  â”‚     â”œâ”€â–º EVENT: product.sold                                        â”‚  â”‚
â”‚  â”‚  â”‚     â”œâ”€â–º EVENT: sale.material (agrupado por material)               â”‚  â”‚
â”‚  â”‚  â”‚     â””â”€â–º EVENT: sale.category (agrupado por tipo_prenda)            â”‚  â”‚
â”‚  â”‚  â”‚         metadata: {"descripcion": "Anillo Oro 18K",                â”‚  â”‚
â”‚  â”‚  â”‚                    "cantidad": 1, "precio": 2500000,               â”‚  â”‚
â”‚  â”‚  â”‚                    "material": "oro_18k", "tipo_prenda": "anillo"} â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚  â””â”€â–º track_full_sale(org_id, user_id, customer_data, items, total)    â”‚  â”‚
â”‚  â”‚        â””â”€â–º Dispara mÃºltiples eventos: customer + products + completed â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ARCHIVO: src/metrics/collectors.py (MetricsCollector)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  collect(event_type, organization_id, user_id, value, success,              â”‚
â”‚          duration_ms, metadata) [lÃ­nea 150]                                  â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â”œâ”€â–º 1. CREAR EVENTO EN MEMORIA                                         â”‚
â”‚      â”‚   MetricEventData(                                                    â”‚
â”‚      â”‚       event_type="invoice.created",                                  â”‚
â”‚      â”‚       timestamp=datetime.utcnow(),                                   â”‚
â”‚      â”‚       organization_id="org-uuid",                                    â”‚
â”‚      â”‚       user_id=1,                                                     â”‚
â”‚      â”‚       value=2975000.0,                                               â”‚
â”‚      â”‚       success=True,                                                  â”‚
â”‚      â”‚       duration_ms=245.5,                                             â”‚
â”‚      â”‚       metadata={"amount": 2975000}                                   â”‚
â”‚      â”‚   )                                                                   â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â”œâ”€â–º 2. AGREGAR A LISTA EN MEMORIA                                      â”‚
â”‚      â”‚   self._events.append(event)                                         â”‚
â”‚      â”‚   # Max 10,000 eventos (FIFO)                                        â”‚
â”‚      â”‚   # RetenciÃ³n: 24 horas                                              â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â”œâ”€â–º 3. ACTUALIZAR CONTADORES                                           â”‚
â”‚      â”‚   self._counters[event_type] += 1                                    â”‚
â”‚      â”‚   self._org_counters[org_id][event_type] += 1                        â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â””â”€â–º 4. PERSISTIR EN BD (ASYNC, NO BLOQUEA)                             â”‚
â”‚          loop.run_in_executor(                                              â”‚
â”‚              _db_executor,  # ThreadPoolExecutor(2)                         â”‚
â”‚              _persist_event_to_db,                                          â”‚
â”‚              event_type, org_id, user_id, value, success,                   â”‚
â”‚              duration_ms, metadata                                          â”‚
â”‚          )                                                                   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ARCHIVO: src/database/queries/metrics_queries.py                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  _persist_event_to_db(...) [ejecutado en ThreadPool]                        â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â””â”€â–º INSERT INTO metric_events                                          â”‚
â”‚          (event_type, organization_id, user_id, value, success,             â”‚
â”‚           duration_ms, event_metadata, created_at)                          â”‚
â”‚          VALUES                                                              â”‚
â”‚          ('invoice.created', 'org-uuid', 1, 2975000.0, true,               â”‚
â”‚           245.5, '{"amount": 2975000}', '2025-12-31 10:30:00')             â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 7. TABLA metric_events

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              metric_events                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  id               â”‚ Integer (PK, autoincrement)                                     â”‚
â”‚  event_type       â”‚ String(50) - INDEXED                                            â”‚
â”‚                   â”‚   Valores: invoice.created, invoice.paid, bot.photo,            â”‚
â”‚                   â”‚            bot.voice, ai.extraction, customer.new,              â”‚
â”‚                   â”‚            product.sold, sale.material, sale.category           â”‚
â”‚                   â”‚                                                                 â”‚
â”‚  organization_id  â”‚ String(36) FK â†’ organizations.id - INDEXED                     â”‚
â”‚                   â”‚   Permite mÃ©tricas globales (NULL) o por tenant                 â”‚
â”‚                   â”‚                                                                 â”‚
â”‚  user_id          â”‚ Integer FK â†’ users.id                                           â”‚
â”‚                   â”‚   Usuario que generÃ³ el evento                                  â”‚
â”‚                   â”‚                                                                 â”‚
â”‚  value            â”‚ Float (default 0.0)                                             â”‚
â”‚                   â”‚   Valor numÃ©rico del evento:                                    â”‚
â”‚                   â”‚   - Para facturas: monto total                                  â”‚
â”‚                   â”‚   - Para productos: precio Ã— cantidad                           â”‚
â”‚                   â”‚   - Para contadores: 1.0                                        â”‚
â”‚                   â”‚                                                                 â”‚
â”‚  success          â”‚ Boolean (default True)                                          â”‚
â”‚                   â”‚   Si la operaciÃ³n fue exitosa                                   â”‚
â”‚                   â”‚                                                                 â”‚
â”‚  duration_ms      â”‚ Float (nullable)                                                â”‚
â”‚                   â”‚   Tiempo de ejecuciÃ³n en milisegundos                           â”‚
â”‚                   â”‚                                                                 â”‚
â”‚  event_metadata   â”‚ JSON                                                            â”‚
â”‚                   â”‚   Datos adicionales especÃ­ficos del evento:                     â”‚
â”‚                   â”‚   - invoice.created: {"amount": 2975000}                        â”‚
â”‚                   â”‚   - bot.photo: {"file_size": 102400}                            â”‚
â”‚                   â”‚   - ai.extraction: {"type": "photo", "confidence": 0.95}        â”‚
â”‚                   â”‚   - product.sold: {"material": "oro_18k", "peso": 5.2}          â”‚
â”‚                   â”‚                                                                 â”‚
â”‚  created_at       â”‚ DateTime - INDEXED                                              â”‚
â”‚                   â”‚   Timestamp UTC del evento                                      â”‚
â”‚                   â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ÃNDICES COMPUESTOS:                                                                â”‚
â”‚  â”œâ”€â–º ix_metrics_org_type (organization_id, event_type)                             â”‚
â”‚  â”œâ”€â–º ix_metrics_org_date (organization_id, created_at)                             â”‚
â”‚  â”œâ”€â–º ix_metrics_type_date (event_type, created_at)                                 â”‚
â”‚  â””â”€â–º ix_metrics_org_type_date (organization_id, event_type, created_at)            â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 8. CONSULTAS DE MÃ‰TRICAS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ARCHIVO: src/database/queries/metrics_queries.py                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  FUNCIONES DISPONIBLES:                                                      â”‚
â”‚                                                                              â”‚
â”‚  get_event_counts(db, organization_id, since) â†’ Dict                        â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â””â”€â–º SELECT event_type,                                                 â”‚
â”‚                 COUNT(*) as count,                                          â”‚
â”‚                 SUM(value) as total_value,                                  â”‚
â”‚                 AVG(CASE WHEN success THEN 1 ELSE 0 END) as success_rate    â”‚
â”‚          FROM metric_events                                                 â”‚
â”‚          WHERE organization_id = 'org' AND created_at >= since              â”‚
â”‚          GROUP BY event_type                                                â”‚
â”‚                                                                              â”‚
â”‚  get_daily_stats(db, organization_id, event_type, days) â†’ List              â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â””â”€â–º SELECT DATE(created_at) as date,                                   â”‚
â”‚                 COUNT(*) as count,                                          â”‚
â”‚                 SUM(value) as total                                         â”‚
â”‚          FROM metric_events                                                 â”‚
â”‚          WHERE organization_id = 'org'                                      â”‚
â”‚            AND event_type = 'invoice.created'                               â”‚
â”‚            AND created_at >= NOW() - INTERVAL days DAY                      â”‚
â”‚          GROUP BY DATE(created_at)                                          â”‚
â”‚          ORDER BY date                                                      â”‚
â”‚                                                                              â”‚
â”‚  get_organization_summary(db, organization_id, since) â†’ Dict                â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â””â”€â–º Retorna:                                                           â”‚
â”‚          {                                                                   â”‚
â”‚            "invoices": {                                                    â”‚
â”‚              "created": 45,                                                 â”‚
â”‚              "paid": 38,                                                    â”‚
â”‚              "total_amount": 125000000,                                     â”‚
â”‚              "avg_amount": 3289473                                          â”‚
â”‚            },                                                                â”‚
â”‚            "bot": {                                                          â”‚
â”‚              "photos": 89,                                                  â”‚
â”‚              "voices": 34,                                                  â”‚
â”‚              "commands": 156,                                               â”‚
â”‚              "photo_success_rate": 0.95                                     â”‚
â”‚            },                                                                â”‚
â”‚            "ai": {                                                           â”‚
â”‚              "extractions": 123,                                            â”‚
â”‚              "success_rate": 0.92,                                          â”‚
â”‚              "avg_confidence": 0.87                                         â”‚
â”‚            },                                                                â”‚
â”‚            "customers": {                                                    â”‚
â”‚              "new": 28,                                                     â”‚
â”‚              "returning": 17                                                â”‚
â”‚            },                                                                â”‚
â”‚            "products": {                                                     â”‚
â”‚              "sold": 156,                                                   â”‚
â”‚              "by_material": {                                               â”‚
â”‚                "oro_18k": 45,                                               â”‚
â”‚                "plata_925": 67,                                             â”‚
â”‚                "oro_rosa": 23                                               â”‚
â”‚              },                                                              â”‚
â”‚              "by_category": {                                               â”‚
â”‚                "anillo": 56,                                                â”‚
â”‚                "cadena": 34,                                                â”‚
â”‚                "arete": 28                                                  â”‚
â”‚              }                                                               â”‚
â”‚            }                                                                 â”‚
â”‚          }                                                                   â”‚
â”‚                                                                              â”‚
â”‚  cleanup_old_events(db, retention_days=90)                                  â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â””â”€â–º DELETE FROM metric_events                                          â”‚
â”‚          WHERE created_at < NOW() - INTERVAL retention_days DAY             â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š REPRESENTACIÃ“N ALTERNATIVA: DIAGRAMA DE FLUJO VERTICAL

```
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   ASESOR        â”‚
                         â”‚  (Telegram)     â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚             â”‚             â”‚
                    â–¼             â–¼             â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  TEXTO   â”‚ â”‚   VOZ    â”‚ â”‚   FOTO   â”‚
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                   â”‚            â”‚            â”‚
                   â–¼            â–¼            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Local    â”‚ â”‚ Whisper  â”‚ â”‚ Vision   â”‚
              â”‚ Parser   â”‚ â”‚ (n8n)    â”‚ â”‚ AI (n8n) â”‚
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                   â”‚            â”‚            â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    GPT-4 EXTRAE:       â”‚
                    â”‚  â€¢ Items (productos)   â”‚
                    â”‚  â€¢ Cliente (datos)     â”‚
                    â”‚  â€¢ Totales (cÃ¡lculos)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   BOT MUESTRA PARA     â”‚
                    â”‚     VERIFICACIÃ“N       â”‚
                    â”‚  [Continuar] [Editar]  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                 â”‚                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ EDITAR   â”‚            â”‚           â”‚ CONFIRMARâ”‚
        â”‚ ITEMS    â”‚            â”‚           â”‚ DATOS    â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â”‚           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
             â”‚                  â”‚                â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   CAPTURA CLIENTE      â”‚
                    â”‚  â€¢ Nombre (obligatorio)â”‚
                    â”‚  â€¢ DirecciÃ³n (opcional)â”‚
                    â”‚  â€¢ Ciudad (opcional)   â”‚
                    â”‚  â€¢ Email (opcional)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   RESUMEN FINAL        â”‚
                    â”‚    [GENERAR]           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                 â”‚                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   BASE DE DATOS  â”‚        â”‚        â”‚   n8n WEBHOOK    â”‚
    â”‚                  â”‚        â”‚        â”‚   /jewelry-pdf   â”‚
    â”‚ â€¢ customers      â”‚        â”‚        â”‚                  â”‚
    â”‚ â€¢ invoices       â”‚        â”‚        â”‚ â€¢ Genera HTML    â”‚
    â”‚ â€¢ invoice_items  â”‚        â”‚        â”‚ â€¢ Crea Google Docâ”‚
    â”‚ â€¢ metric_events  â”‚        â”‚        â”‚ â€¢ Exporta PDF    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚                 â”‚
                                â–¼                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         USUARIO RECIBE             â”‚
                    â”‚  ğŸ“„ HTML + ğŸ“‘ PDF + âœ… ConfirmaciÃ³n â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

---

# ğŸ“Š DIAGRAMAS MERMAID.JS

## 1. DIAGRAMA DE FLUJO BACKEND COMPLETO

```mermaid
flowchart TB
    subgraph TELEGRAM["ğŸ“± TELEGRAM"]
        USER["ğŸ‘¤ Asesor"]
    end

    subgraph INPUT["ğŸ“¥ CAPTURA DE INPUT"]
        TEXT["ğŸ“ Texto"]
        VOICE["ğŸ¤ Voz (.ogg)"]
        PHOTO["ğŸ“· Foto (.jpg)"]
    end

    subgraph BOT["ğŸ¤– BOT PYTHON"]
        subgraph HANDLERS["handlers/invoice.py"]
            INIT["iniciar_nueva_factura()<br/>lÃ­nea 97"]
            SELECT["seleccionar_tipo_input()<br/>lÃ­nea 125"]
            RECEIVE["recibir_input()<br/>lÃ­nea 181"]
            CONFIRM["confirmar_datos()<br/>lÃ­nea 477"]
            CLIENT_DATA["datos_cliente()<br/>lÃ­neas 590-650"]
            GENERATE["generar_factura()<br/>lÃ­nea 695"]
        end

        subgraph SERVICES["services/"]
            N8N_SVC["n8n_service.py<br/>send_voice/photo_input()"]
            TEXT_PARSER["text_parser.py<br/>parse()"]
            HTML_GEN["html_generator.py<br/>generate()"]
        end
    end

    subgraph N8N["âš¡ n8n WORKFLOWS"]
        EXTRACT_WH["Webhook<br/>/jewelry-extract"]
        WHISPER["OpenAI Whisper<br/>TranscripciÃ³n"]
        VISION["Vision AI<br/>OCR"]
        GPT4["GPT-4<br/>ExtracciÃ³n items"]
        PDF_WH["Webhook<br/>/jewelry-pdf"]
        GDOC["Google Docs<br/>Crear documento"]
        EXPORT_PDF["Export PDF<br/>Descargar"]
    end

    subgraph DATABASE["ğŸ—„ï¸ BASE DE DATOS"]
        subgraph QUERIES["queries/"]
            CUST_Q["customer_queries.py<br/>find_or_create_customer_async()"]
            INV_Q["invoice_queries.py<br/>create_invoice_with_items_async()"]
            ITEM_Q["invoice_item_queries.py<br/>create_invoice_items_async()"]
            METRIC_Q["metrics_queries.py<br/>_persist_event_to_db()"]
        end

        subgraph TABLES["TABLAS"]
            CUSTOMERS[("customers<br/>nombre, cedula,<br/>telefono, email")]
            INVOICES[("invoices<br/>numero_factura,<br/>estado, total")]
            ITEMS[("invoice_items<br/>descripcion, precio,<br/>material, tipo")]
            METRICS[("metric_events<br/>event_type, value,<br/>metadata")]
        end
    end

    subgraph METRICS_SYS["ğŸ“ˆ SISTEMA MÃ‰TRICAS"]
        TRACKER["tracker.py<br/>MetricsTracker"]
        COLLECTOR["collectors.py<br/>MetricsCollector"]
    end

    subgraph OUTPUT["ğŸ“¤ SALIDA"]
        HTML_FILE["ğŸ“„ HTML"]
        PDF_FILE["ğŸ“‘ PDF"]
        CONFIRM_MSG["âœ… ConfirmaciÃ³n"]
    end

    %% Flujo principal
    USER -->|"/start"| INIT
    INIT --> SELECT
    SELECT --> TEXT & VOICE & PHOTO

    TEXT -->|"texto plano"| TEXT_PARSER
    VOICE -->|"base64"| N8N_SVC
    PHOTO -->|"base64"| N8N_SVC

    TEXT_PARSER -->|"items locales"| RECEIVE
    N8N_SVC -->|"POST"| EXTRACT_WH

    EXTRACT_WH -->|"audio"| WHISPER
    EXTRACT_WH -->|"imagen"| VISION
    WHISPER --> GPT4
    VISION --> GPT4
    GPT4 -->|"N8NResponse"| RECEIVE

    RECEIVE -->|"mostrar verificaciÃ³n"| CONFIRM
    CONFIRM -->|"Continuar"| CLIENT_DATA
    CLIENT_DATA -->|"datos completos"| GENERATE

    %% Persistencia
    GENERATE --> CUST_Q
    CUST_Q -->|"INSERT/SELECT"| CUSTOMERS
    GENERATE --> INV_Q
    INV_Q -->|"INSERT"| INVOICES
    INV_Q --> ITEM_Q
    ITEM_Q -->|"INSERT mÃºltiple"| ITEMS

    %% MÃ©tricas
    GENERATE --> TRACKER
    TRACKER --> COLLECTOR
    COLLECTOR -->|"ThreadPool async"| METRIC_Q
    METRIC_Q -->|"INSERT"| METRICS

    %% GeneraciÃ³n PDF
    GENERATE --> HTML_GEN
    GENERATE --> N8N_SVC
    N8N_SVC -->|"POST"| PDF_WH
    PDF_WH --> GDOC
    GDOC --> EXPORT_PDF

    %% Salida
    HTML_GEN --> HTML_FILE
    EXPORT_PDF --> PDF_FILE
    GENERATE --> CONFIRM_MSG

    HTML_FILE --> USER
    PDF_FILE --> USER
    CONFIRM_MSG --> USER

    %% Estilos
    classDef telegram fill:#0088cc,color:white
    classDef bot fill:#4CAF50,color:white
    classDef n8n fill:#FF6D00,color:white
    classDef db fill:#2196F3,color:white
    classDef metrics fill:#9C27B0,color:white
    classDef output fill:#4CAF50,color:white

    class USER telegram
    class INIT,SELECT,RECEIVE,CONFIRM,CLIENT_DATA,GENERATE bot
    class EXTRACT_WH,WHISPER,VISION,GPT4,PDF_WH,GDOC,EXPORT_PDF n8n
    class CUSTOMERS,INVOICES,ITEMS,METRICS db
    class TRACKER,COLLECTOR metrics
    class HTML_FILE,PDF_FILE,CONFIRM_MSG output
```

---

## 2. DIAGRAMA DE SECUENCIA TEMPORAL

```mermaid
sequenceDiagram
    autonumber
    participant U as ğŸ‘¤ Asesor
    participant T as ğŸ“± Telegram
    participant B as ğŸ¤– Bot Python
    participant H as handlers/invoice.py
    participant S as n8n_service.py
    participant N as âš¡ n8n
    participant DB as ğŸ—„ï¸ Database
    participant M as ğŸ“ˆ Metrics

    Note over U,M: FASE 1: AUTENTICACIÃ“N Y CAPTURA

    U->>T: /start
    T->>B: Update message
    B->>H: iniciar_nueva_factura()
    H->>H: context.user_data['estado'] = 'SELECCIONAR_INPUT'
    H-->>T: "Seleccione tipo de input: Texto/Voz/Foto"
    T-->>U: Mostrar opciones

    U->>T: EnvÃ­a audio .ogg
    T->>B: Update voice message
    B->>H: seleccionar_tipo_input() â†’ VOZ
    H->>H: file.download_to_drive(audio_path)

    Note over U,M: FASE 2: EXTRACCIÃ“N CON IA

    H->>S: send_voice_input(audio_path, cedula)
    S->>S: base64.b64encode(audio)
    S->>S: _build_extract_payload()
    S->>N: POST /webhook/jewelry-extract

    Note right of N: OpenAI Whisper<br/>Transcribe audio
    N->>N: Whisper â†’ texto
    Note right of N: GPT-4<br/>Extrae items
    N->>N: GPT-4 â†’ items, cliente, totales
    N-->>S: N8NResponse JSON

    S->>S: _parse_extract_response()
    S-->>H: N8NResponse(items, cliente, totales)

    H->>H: Formatear items (Title Case)
    H->>H: context.user_data['n8n_response'] = {...}
    H-->>T: "ğŸ“¦ PRODUCTOS DETECTADOS\nğŸ“„ Items...\nğŸ‘¤ Cliente..."
    T-->>U: Mostrar verificaciÃ³n

    Note over U,M: FASE 3: CONFIRMACIÃ“N Y DATOS CLIENTE

    U->>T: "Continuar"
    T->>B: Update callback
    B->>H: confirmar_datos()
    H-->>T: "ğŸ“ Ingrese NOMBRE del cliente:"
    T-->>U: Pedir nombre

    U->>T: "Juan PÃ©rez"
    T->>B: Update message
    B->>H: datos_cliente()
    H->>H: IdentityValidator.validate_nombre_persona()
    H->>H: context.user_data['cliente_nombre'] = "Juan PÃ©rez"
    H-->>T: "ğŸ“ Ingrese DIRECCIÃ“N (o 'omitir'):"

    Note over U,T: ... repite para direcciÃ³n, ciudad, email ...

    H->>H: _mostrar_resumen_factura()
    H-->>T: "RESUMEN FINAL\n[GENERAR FACTURA]"
    T-->>U: BotÃ³n generar

    Note over U,M: FASE 4: PERSISTENCIA EN BASE DE DATOS

    U->>T: Click "GENERAR"
    T->>B: Update callback
    B->>H: generar_factura()

    H->>H: Rate limit check

    rect rgb(200, 220, 255)
        Note over H,DB: TRANSACCIÃ“N ATÃ“MICA
        H->>DB: find_or_create_customer_async()
        DB->>DB: SELECT FROM customers WHERE cedula=?
        alt Cliente no existe
            DB->>DB: INSERT INTO customers
        end
        DB-->>H: customer_id

        H->>DB: generate_invoice_number()
        DB->>DB: SELECT MAX(numero_factura)
        DB-->>H: "FAC-202512-0043"

        H->>DB: INSERT INTO invoices
        DB-->>H: invoice_id

        H->>DB: create_invoice_items_async()
        loop Para cada item
            DB->>DB: INSERT INTO invoice_items
        end
        DB-->>H: âœ“ Commit
    end

    Note over U,M: FASE 5: MÃ‰TRICAS

    H->>M: track_invoice_created(org_id, amount)
    M->>M: MetricEventData en memoria
    M->>M: Actualizar contadores

    par Async (no bloquea)
        M->>DB: INSERT INTO metric_events (ThreadPool)
    end

    H->>M: track_customer_new(cedula, nombre)
    H->>M: track_product_sale() Ã— N items

    Note over U,M: FASE 6: GENERACIÃ“N DE DOCUMENTOS

    par GeneraciÃ³n paralela
        H->>H: html_generator.generate()
        H-->>H: HTML string
    and
        H->>S: generate_pdf(invoice_data)
        S->>N: POST /webhook/jewelry-pdf
        N->>N: Crear Google Doc
        N->>N: Exportar como PDF
        N-->>S: N8NPDFResponse(pdf_url)
        S-->>H: PDF ready
    end

    Note over U,M: FASE 7: ENTREGA AL USUARIO

    H->>T: send_document(HTML file)
    T-->>U: ğŸ“„ Factura HTML

    H->>H: Descargar PDF desde Google Drive
    H->>T: send_document(PDF file)
    T-->>U: ğŸ“‘ Factura PDF

    H->>T: "âœ… Factura FAC-202512-0043 generada"
    T-->>U: ConfirmaciÃ³n final
```

---

## 3. DIAGRAMA ENTIDAD-RELACIÃ“N (ER)

```mermaid
erDiagram
    organizations ||--o{ users : "tiene"
    organizations ||--o{ customers : "tiene"
    organizations ||--o{ invoices : "tiene"
    organizations ||--o{ invoice_drafts : "tiene"
    organizations ||--|| tenant_configs : "configura"
    organizations ||--o{ metric_events : "genera"
    organizations ||--o{ audit_logs : "registra"

    users ||--o{ invoices : "crea como vendedor"
    users ||--o{ invoice_drafts : "crea"
    users ||--o{ metric_events : "genera"
    users ||--o{ audit_logs : "realiza"

    customers ||--o{ invoices : "recibe"

    invoices ||--o{ invoice_items : "contiene"
    invoices ||--o{ audit_logs : "tiene"
    invoices ||--o| invoice_drafts : "originado de"

    organizations {
        uuid id PK
        string name "Nombre empresa"
        string slug UK "URL-friendly"
        string plan "basic|pro|enterprise"
        string status "active|suspended"
        json settings "ConfiguraciÃ³n"
        string email
        string telefono
        string direccion
        datetime created_at
        boolean is_deleted
    }

    users {
        int id PK
        uuid organization_id FK
        string cedula UK "NÃºmero documento"
        string nombre_completo
        string email
        string telefono
        string password_hash
        string rol "ADMIN|VENDEDOR"
        bigint telegram_id "ID Telegram bot"
        boolean activo
        datetime ultimo_login
        datetime created_at
        boolean is_deleted
    }

    customers {
        uuid id PK
        uuid organization_id FK
        string nombre
        string cedula "Nullable"
        string telefono
        string email
        string direccion
        string ciudad
        text notas "Preferencias"
        datetime created_at
        boolean is_deleted
    }

    invoices {
        uuid id PK
        uuid organization_id FK
        string numero_factura UK "FAC-YYYYMM-NNNN"
        uuid customer_id FK "Nullable"
        string cliente_nombre "Legacy"
        string cliente_direccion "Legacy"
        string cliente_ciudad "Legacy"
        string cliente_email "Legacy"
        string cliente_telefono "Legacy"
        string cliente_cedula "Legacy"
        json items "Legacy JSON"
        float subtotal
        float descuento
        float impuesto "19% IVA"
        float total
        string estado "BORRADOR|PENDIENTE|PAGADA|ANULADA"
        int vendedor_id FK
        datetime fecha_pago "Nullable"
        string input_type "TEXTO|VOZ|FOTO"
        text input_raw "Path o texto"
        boolean n8n_processed
        json n8n_response "Respuesta IA"
        text notas
        int version "Optimistic locking"
        datetime created_at
        datetime updated_at
        boolean is_deleted
    }

    invoice_items {
        int id PK
        uuid invoice_id FK
        int numero "Orden 1,2,3..."
        string descripcion "Anillo Oro 18K"
        int cantidad
        float precio_unitario
        float subtotal "cantidad x precio"
        string material "oro_18k|plata_925|oro_rosa"
        float peso_gramos "Peso joyerÃ­a"
        string tipo_prenda "anillo|cadena|arete|pulsera"
        datetime created_at
    }

    tenant_configs {
        uuid organization_id PK,FK
        string invoice_prefix "FAC|FV|etc"
        float tax_rate "0.19 = 19%"
        string currency "COP"
        json settings
    }

    invoice_drafts {
        uuid id PK
        uuid organization_id FK
        int user_id FK
        bigint telegram_chat_id
        string current_step "Paso actual flujo"
        string input_type
        text input_raw
        string input_file_path
        json ai_response_raw "Respuesta IA original"
        datetime ai_extraction_timestamp
        json items_data "Items modificables"
        json customer_data
        json totals_data
        json change_history "Historial cambios"
        string status "active|completed|cancelled"
        datetime expires_at
        uuid invoice_id FK "Factura final"
        datetime created_at
    }

    metric_events {
        int id PK
        string event_type "invoice.created|bot.photo|..."
        uuid organization_id FK "Nullable para globales"
        int user_id FK
        float value "Monto o contador"
        boolean success
        float duration_ms
        json event_metadata "Datos adicionales"
        datetime created_at
    }

    audit_logs {
        int id PK
        uuid organization_id FK
        int usuario_id FK
        string usuario_cedula "Para tracking"
        string accion "create|update|delete"
        string entidad_tipo "Invoice|Customer"
        string entidad_id
        json detalles
        json old_values
        json new_values
        string ip_address
        string user_agent
        datetime timestamp
        uuid invoice_id FK "Opcional"
    }
```

---

## 4. FLUJO DE MÃ‰TRICAS DETALLADO

```mermaid
flowchart LR
    subgraph EVENTOS["ğŸ“Š EVENTOS CAPTURADOS"]
        direction TB
        E1["invoice.created<br/>Monto: $2,975,000"]
        E2["invoice.paid<br/>DÃ­as para pago: 5"]
        E3["bot.photo<br/>DuraciÃ³n: 2450ms"]
        E4["bot.voice<br/>Success: true"]
        E5["ai.extraction<br/>Confianza: 0.95"]
        E6["customer.new<br/>CÃ©dula: 123456"]
        E7["product.sold<br/>Material: oro_18k"]
        E8["sale.category<br/>Tipo: anillo"]
    end

    subgraph TRACKER["ğŸ“ˆ MetricsTracker"]
        direction TB
        T1["track_invoice_created()"]
        T2["track_invoice_paid()"]
        T3["track_bot_photo()"]
        T4["track_bot_voice()"]
        T5["track_ai_extraction()"]
        T6["track_customer_new()"]
        T7["track_product_sale()"]
    end

    subgraph COLLECTOR["ğŸ”„ MetricsCollector"]
        direction TB
        C1["collect()<br/>Crea MetricEventData"]
        C2["_events.append()<br/>Max 10,000 FIFO"]
        C3["_counters[type] += 1"]
        C4["_org_counters[org][type] += 1"]
    end

    subgraph STORAGE["ğŸ’¾ ALMACENAMIENTO"]
        direction TB
        MEM["ğŸ§  MEMORIA<br/>Ãšltimas 24h<br/>Acceso rÃ¡pido"]
        DB["ğŸ—„ï¸ BASE DATOS<br/>metric_events<br/>HistÃ³rico 90 dÃ­as"]
    end

    subgraph QUERIES["ğŸ“Š CONSULTAS"]
        direction TB
        Q1["get_event_counts()<br/>Conteos por tipo"]
        Q2["get_daily_stats()<br/>Series temporales"]
        Q3["get_organization_summary()<br/>Resumen completo"]
        Q4["get_jewelry_metrics()<br/>Materiales, categorÃ­as"]
    end

    subgraph API["ğŸŒ ENDPOINTS"]
        direction TB
        A1["GET /metrics<br/>JSON completo"]
        A2["GET /metrics/prometheus<br/>Formato Prometheus"]
        A3["GET /metrics/business<br/>KPIs negocio"]
        A4["GET /metrics/business/organizations/{id}/health<br/>Score 0-100"]
    end

    %% Conexiones
    E1 --> T1
    E2 --> T2
    E3 --> T3
    E4 --> T4
    E5 --> T5
    E6 --> T6
    E7 & E8 --> T7

    T1 & T2 & T3 & T4 & T5 & T6 & T7 --> C1
    C1 --> C2 & C3 & C4

    C2 --> MEM
    C1 -->|"ThreadPool<br/>async"| DB

    MEM --> Q1 & Q2 & Q3 & Q4
    DB --> Q1 & Q2 & Q3 & Q4

    Q1 & Q2 & Q3 & Q4 --> A1 & A2 & A3 & A4

    %% Estilos
    classDef event fill:#E3F2FD,stroke:#1976D2
    classDef tracker fill:#E8F5E9,stroke:#388E3C
    classDef collector fill:#FFF3E0,stroke:#F57C00
    classDef storage fill:#F3E5F5,stroke:#7B1FA2
    classDef query fill:#FFEBEE,stroke:#C62828
    classDef api fill:#E0F7FA,stroke:#00838F

    class E1,E2,E3,E4,E5,E6,E7,E8 event
    class T1,T2,T3,T4,T5,T6,T7 tracker
    class C1,C2,C3,C4 collector
    class MEM,DB storage
    class Q1,Q2,Q3,Q4 query
    class A1,A2,A3,A4 api
```

---

## 5. FLUJO DE DATOS CLIENTE (NORMALIZACIÃ“N)

```mermaid
flowchart TB
    subgraph INPUT["ğŸ“¥ DATOS ENTRANTES"]
        N8N_CLIENTE["n8n extrae:<br/>nombre, telÃ©fono,<br/>direcciÃ³n, ciudad"]
        MANUAL["Usuario ingresa:<br/>nombre, direcciÃ³n,<br/>ciudad, email"]
    end

    subgraph VALIDATION["âœ… VALIDACIÃ“N"]
        VAL["IdentityValidator<br/>.validate_nombre_persona()"]
    end

    subgraph QUERY["ğŸ” BÃšSQUEDA"]
        Q1["find_or_create_customer_async()"]
        Q2{"Â¿Existe por<br/>cÃ©dula?"}
        Q3{"Â¿Existe por<br/>telÃ©fono?"}
        Q4["Retorna customer_id"]
    end

    subgraph CREATE["â• CREAR NUEVO"]
        INSERT["INSERT INTO customers<br/>(id, org_id, nombre,<br/>cedula, telefono, email,<br/>direccion, ciudad)"]
    end

    subgraph UPDATE["âœï¸ ACTUALIZAR"]
        UPD["UPDATE customers<br/>SET nombre=?, telefono=?<br/>WHERE id=?"]
    end

    subgraph LINK["ğŸ”— VINCULAR A FACTURA"]
        INV["invoices.customer_id = ?"]
        LEGACY["invoices.cliente_nombre = ?<br/>invoices.cliente_direccion = ?<br/>(legacy/redundante)"]
    end

    subgraph STATS["ğŸ“Š MÃ‰TRICAS"]
        NEW["track_customer_new()<br/>â†’ customer.new"]
        RET["track_customer_returning()<br/>â†’ customer.returning"]
    end

    N8N_CLIENTE --> VAL
    MANUAL --> VAL
    VAL --> Q1
    Q1 --> Q2
    Q2 -->|"SÃ­"| Q4
    Q2 -->|"No"| Q3
    Q3 -->|"SÃ­"| Q4
    Q3 -->|"No"| INSERT
    INSERT --> Q4
    Q4 --> INV
    Q4 --> LEGACY

    INSERT --> NEW
    Q4 -->|"Cliente existente"| RET

    %% Estilos
    classDef input fill:#E3F2FD
    classDef validation fill:#E8F5E9
    classDef query fill:#FFF3E0
    classDef create fill:#E8F5E9
    classDef link fill:#F3E5F5
    classDef stats fill:#FFEBEE

    class N8N_CLIENTE,MANUAL input
    class VAL validation
    class Q1,Q2,Q3,Q4 query
    class INSERT,UPD create
    class INV,LEGACY link
    class NEW,RET stats
```

---

## ğŸ“ ARCHIVOS CLAVE REFERENCIADOS

| Archivo | LÃ­neas Clave | Responsabilidad |
|---------|--------------|-----------------|
| `src/bot/handlers/invoice.py` | 97, 181, 477, 695 | OrquestaciÃ³n del flujo |
| `src/services/n8n_service.py` | 79, 104, 141, 293 | ComunicaciÃ³n con n8n |
| `src/database/models.py` | 150-400 | Modelos SQLAlchemy |
| `src/database/queries/invoice_queries.py` | * | CRUD facturas |
| `src/database/queries/customer_queries.py` | * | CRUD clientes |
| `src/database/queries/metrics_queries.py` | * | MÃ©tricas y analytics |
| `src/metrics/tracker.py` | * | Tracking de eventos |
| `src/metrics/collectors.py` | 150, 354 | Persistencia mÃ©tricas |
